<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VL53L0X Live Dashboard</title>
  <style>
    :root{
      --bg: #0b0f17;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --good: #34d399;
      --warn: #fbbf24;
      --bad:  #fb7185;
      --border: rgba(255,255,255,0.10);
    }
    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(52,211,153,0.12), transparent 60%),
        radial-gradient(900px 500px at 90% 20%, rgba(59,130,246,0.12), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(251,113,133,0.10), transparent 60%),
        var(--bg);
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 28px;
    }
    .wrap{
      width:min(980px, 100%);
      display:grid;
      gap:16px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      padding: 10px 6px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: 0.2px;
    }
    .subtitle{
      color: var(--muted);
      font-size: 13px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .dot{
      width:10px;
      height:10px;
      border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(251,191,36,0.18);
    }
    .dot.good{
      background: var(--good);
      box-shadow: 0 0 0 4px rgba(52,211,153,0.18);
    }
    .dot.bad{
      background: var(--bad);
      box-shadow: 0 0 0 4px rgba(251,113,133,0.18);
    }

    .grid{
      display:grid;
      gap:16px;
      grid-template-columns: 1.3fr 1fr;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 18px;
      padding: 18px;
      backdrop-filter: blur(10px);
    }
    .big{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
    }
    .reading{
      font-size: 64px;
      line-height: 1;
      font-weight: 750;
      letter-spacing: -0.8px;
    }
    .unit{
      font-size: 14px;
      color: var(--muted);
      padding-bottom: 10px;
    }
    .meta{
      margin-top: 12px;
      display:grid;
      gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    .kv{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 12px;
    }
    .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .v{
      font-size: 16px;
      font-weight: 650;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .barWrap{
      margin-top: 14px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
    }
    .barHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
      color: var(--muted);
      font-size: 12px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow:hidden;
      position: relative;
    }
    .fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(52,211,153,0.95), rgba(59,130,246,0.95));
      transition: width 220ms ease;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
      line-height: 1.5;
    }

    .sideTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }
    button{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 650;
      font-size: 13px;
    }
    button:hover{
      background: rgba(255,255,255,0.08);
    }
    input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.15);
      color: var(--text);
      outline: none;
      font-size: 13px;
    }
    .log{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.20);
      border: 1px solid var(--border);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: rgba(255,255,255,0.82);
      height: 280px;
      overflow:auto;
      white-space: pre;
    }
    .muted{ color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Live Sensor Dashboard</h1>
        <div class="subtitle">Reads the latest line from <span class="muted">log.json</span> (NDJSON) and updates automatically.</div>
      </div>

      <div class="pill" title="Connection status (based on successful fetch + fresh data)">
        <span id="dot" class="dot"></span>
        <span id="statusText">Starting…</span>
      </div>
    </header>

    <div class="grid">
      <!-- Main Reading -->
      <section class="card">
        <div class="big">
          <div class="reading"><span id="reading">—</span></div>
          <div class="unit" id="unit">mm</div>
        </div>

        <div class="meta">
          <div class="kv">
            <div class="k">Device</div>
            <div class="v" id="device">—</div>
          </div>
          <div class="kv">
            <div class="k">Last updated</div>
            <div class="v" id="updated">—</div>
          </div>
          <div class="kv">
            <div class="k">Raw JSON</div>
            <div class="v" id="rawOneLine">—</div>
          </div>
          <div class="kv">
            <div class="k">Polling</div>
            <div class="v"><span id="pollMs">100</span> ms</div>
          </div>
        </div>

        <div class="barWrap">
          <div class="barHead">
            <span>Range (auto scaled)</span>
            <span><span id="minVal">—</span> → <span id="maxVal">—</span></span>
          </div>
          <div class="bar"><div class="fill" id="fill"></div></div>
          <div class="hint">
            Tip: Your file is NDJSON (one JSON per line). This dashboard reads the <b>last non-empty line</b> as the newest sample.
          </div>
        </div>
      </section>

      <!-- Controls + Recent log -->
      <aside class="card">
        <div class="sideTop">
          <div style="font-weight:750;">Controls</div>
          <div class="btnRow">
            <button id="pauseBtn">Pause</button>
            <button id="clearBtn" title="Clears only the on-screen log (not the file)">Clear view</button>
          </div>
        </div>

        <label class="muted" style="display:block; margin-bottom:8px;">Device filter (optional)</label>
        <input id="deviceFilter" placeholder='e.g. VL53L0X-withSerial_log (leave empty = show latest line)' />

        <div class="hint" style="margin-top:12px;">
          If your browser shows <span class="muted">304</span>, it’s just caching. This page uses <span class="muted">?t=Date.now()</span> to bypass cache automatically.
        </div>

        <div class="log" id="log">Waiting for data…</div>
      </aside>
    </div>
  </div>

  <script>
    // --- Config ---
    let POLL_MS = 100;           // match your Arduino interval if you want

    // Fixed sensor range (VL53L0X typical stable range)
    const FIXED_MIN = 50;    // mm
    const FIXED_MAX = 1200;  // mm
    const MAX_LOG_LINES = 40;    // on-screen log length

    // --- State ---
    let paused = false;
    let lastLine = "";
    let lastUpdateMs = 0;
    let minSeen = null;
    let maxSeen = null;
    let logLines = [];

    // --- Elements ---
    const el = (id) => document.getElementById(id);
    const dot = el("dot");
    const statusText = el("statusText");
    const reading = el("reading");
    const device = el("device");
    const updated = el("updated");
    const rawOneLine = el("rawOneLine");
    const fill = el("fill");
    const minVal = el("minVal");
    const maxVal = el("maxVal");
    const pollMs = el("pollMs");
    const logBox = el("log");
    const pauseBtn = el("pauseBtn");
    const clearBtn = el("clearBtn");
    const deviceFilterInput = el("deviceFilter");

    pollMs.textContent = String(POLL_MS);

    pauseBtn.addEventListener("click", () => {
      paused = !paused;
      pauseBtn.textContent = paused ? "Resume" : "Pause";
      setStatus(paused ? "Paused" : "Running", paused ? "warn" : "good");
    });

    clearBtn.addEventListener("click", () => {
      logLines = [];
      logBox.textContent = "Cleared view.";
    });

    function setStatus(text, level) {
      statusText.textContent = text;
      dot.classList.remove("good", "bad");
      if (level === "good") dot.classList.add("good");
      if (level === "bad") dot.classList.add("bad");
      // warn = default yellow
    }

    function nowStr() {
      return new Date().toLocaleTimeString();
    }

    function pickLastNonEmptyLine(text) {
      const lines = text.split(/\r?\n/);
      for (let i = lines.length - 1; i >= 0; i--) {
        const s = lines[i].trim();
        if (s) return s;
      }
      return "";
    }

    function parseNDJSONForDevice(text, wantedDevice) {
      // If wantedDevice empty: return newest line
      if (!wantedDevice) return pickLastNonEmptyLine(text);

      // Otherwise scan from bottom and find last line matching device name
      const lines = text.split(/\r?\n/);
      for (let i = lines.length - 1; i >= 0; i--) {
        const s = lines[i].trim();
        if (!s) continue;
        try {
          const obj = JSON.parse(s);
          if (obj && String(obj.device) === wantedDevice) return s;
        } catch (_) {}
      }
      return "";
    }

    function updateBar(value) {
    // display fixed range
    minVal.textContent = String(FIXED_MIN);
    maxVal.textContent = String(FIXED_MAX);

    // clamp to range so outliers don't break UI
    const clamped = Math.max(FIXED_MIN, Math.min(FIXED_MAX, value));

    const span = Math.max(1, FIXED_MAX - FIXED_MIN);
    const pct = ((clamped - FIXED_MIN) / span) * 100;

    fill.style.width = `${pct}%`;
    }

    function appendLog(line) {
      logLines.push(line);
      if (logLines.length > MAX_LOG_LINES) logLines.shift();
      logBox.textContent = logLines.join("\n");
      logBox.scrollTop = logBox.scrollHeight;
    }

    async function tick() {
      if (paused) return;

      try {
        // cache-bust to avoid 304
        const res = await fetch(`log.json?t=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const text = await res.text();

        const wanted = deviceFilterInput.value.trim();
        const line = parseNDJSONForDevice(text, wanted);

        if (!line) {
          setStatus("No data yet", "warn");
          return;
        }

        // Only update if line changed
        if (line !== lastLine) {
          lastLine = line;
          lastUpdateMs = Date.now();

          let obj;
          try {
            obj = JSON.parse(line);
          } catch (e) {
            setStatus("Latest line is not valid JSON", "bad");
            return;
          }

          const v = Number(obj.sensor);
          reading.textContent = Number.isFinite(v) ? v : "—";
          device.textContent = obj.device ?? "—";
          updated.textContent = nowStr();
          rawOneLine.textContent = line.length > 48 ? (line.slice(0, 48) + "…") : line;

          if (Number.isFinite(v)) updateBar(v);

          appendLog(line);
          setStatus("Live", "good");
        } else {
          // same line as before, check if it's stale
          const age = Date.now() - lastUpdateMs;
          if (lastUpdateMs && age > POLL_MS * 6) {
            setStatus("Stale (no new lines)", "warn");
          } else {
            setStatus("Live", "good");
          }
        }
      } catch (err) {
        setStatus("Fetch failed (server?)", "bad");
      }
    }

    // Start
    setStatus("Starting…", "warn");
    tick();
    setInterval(tick, POLL_MS);
  </script>
</body>
</html>